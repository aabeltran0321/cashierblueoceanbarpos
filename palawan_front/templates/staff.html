<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Point of Sale</title>
    <link rel="stylesheet" href="../static/styles/main.css">
    <link rel="stylesheet" href="../static/styles/staff.css">
    <link rel="stylesheet" href="../static/styles/cont43.css">
</head>

<body>
    <div class="cont43">
    <aside id="AsideAuthority" data-role="">
        <div class="aside-container" id="NavPOSStaff" onclick="window.location.href='/dashboard_manager'" ><p>Point of Sales <br></p></div>
        <div class="aside-container active" id="NavStaff"><p>Staff <br> Management</p></div>
        <div class="aside-container" id="ModalLogout"><p>Logout</p></div>
    </aside>

    <main>
        <div class="Header-Main-Container">
            <div class="Header-Main-Container-V2">
                <div
                    style="display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 10px 20px; border-radius: 5px; background-color: #1c2224;">
                    <img src="../static/icons/equalizer-line.png" width="24" height="24">
                    <p style="color: #fff;">Staff Management</p>
                </div>
            </div>
            
            <div class="Header-Main-Container-V2" style="position: relative;">
                <input id="Search" type="search" placeholder="Search">
                <img src="../static/icons/search-line.png"
                    style="position: absolute; right: 5px; top: 5; width: 28px; height: 28px;">
            </div>
            
        </div>
        <div>
            <button class="OpenModal"
                style="cursor: pointer; color: #fff; background-color: #00bf63; padding: 10px 50px; border-radius: 10px; border: none;">Add
                Staff</button>
            </div>

        <div class="Main-Container">
            <table id="staffTable">
                <thead>
                    <tr>
                        <th>Staff ID</th>
                        <th>Fullname</th>
                        <th>Email</th>
                        <th>Department</th>
                        <th>Role</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="staffTableBody">
                    <!-- JS -->
                </tbody>
            </table>
        </div>

        
    </main>

    <!-- Modal for Add / Update Staff -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <div>
                <p style="font-size: 20px; font-weight: bold; text-align: center;" id="modalTitle">Staff Details</p>
            </div>
            <div class="Input-Staff-Container">

                <div class="Input-Staff">
                    <label for="Enumber">Employee ID:</label>
                    <input type="text" name="Enumber" id="Enumber" required>
                </div>
                <div class="Input-Staff">
                    <label for="password">Password:</label>
                    <div style="position: relative;">
                        <input type="password" minlength="1" maxlength="40" pattern=".{40}"
                            title="Password must be exactly 40 characters" name="password" id="password"
                            style="padding: 5px; color: #111; outline: none; width: 450px;" required>
                        <img src="../static/icons/eye-off-line.png" id="eyeToggle"
                            style="cursor: pointer; position: absolute; right: 5px; top: 3px; width: 24px; height: 24px;">
                    </div>
                </div>
                <div class="Input-Staff">
                    <label for="email">Email:</label>
                    <input type="email" name="email" id="email" required>
                </div>
            </div>
            <div class="Input-Staff-Container">
                <div class="Input-Staff">
                    <label for="fname">Fullname:</label>
                    <input type="text" name="fname" id="fname" placeholder="First Name, Last Name" required>
                </div>
            </div>
            <div class="Input-Staff-Container">
                <div class="Input-Staff">
                    <label for="role">Role:</label>
                    <select name="role" id="role" required>
                        <option value="Staff">Staff</option>
                        <option value="Manager">Manager</option>
                        <option value="Waiter">Waiter</option>
                    </select>
                </div>
                <div class="Input-Staff">
                    <label for="department">Department:</label>
                    <select name="department" id="department" required>
                        <option value="Mainland">Mainland</option>
                        <option value="Floating Bar">Floating Bar</option>
                    </select>
                </div>
            </div>
            <hr style="border: 1px solid #111; width: 100%;">
            <div class="Button-Container">
                <button id="CloseModal" style="background-color: #d9d9d9; color: #111;">CANCEL</button>
                <button id="AddStaff" style="background-color: #00bf63; color: #fff;">SUBMIT</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="Modal-Content" style="width: 350px; text-align:center;">
            <p>Are you sure you want to delete this staff?</p>
            <div style="margin-top:20px;">
                <button id="confirmDelete" style="margin-right:10px; background-color:#d32f2f;">Delete</button>
                <button id="closeDeleteModal" style="background-color:#555;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
        <div class="Modal-Content" style="width: 350px; text-align:center;">
            <p>Are you sure you want to logout?</p>
            <div style="margin-top:20px;">
                <button id="YESLOGOUT" onclick="window.location.href='/'"
                    style="margin-right:10px; background-color:#d32f2f;">Logout</button>
                <button id="cancelLogoutBtn" style="background-color:#555;" onclick="hideLogout();">Cancel</button>
            </div>
        </div>
    </div></div>
    <script src="../static/scripts/logout.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById("myModal");
    const deleteModal = document.getElementById("deleteModal");
    const closeButton = document.getElementById("CloseModal");
    const closeDeleteButton = document.getElementById("closeDeleteModal");
    const addButton = document.getElementById("AddStaff");
    const confirmDeleteButton = document.getElementById("confirmDelete");
    const eyeToggle = document.getElementById("eyeToggle");
    const passwordField = document.getElementById("password");
    const searchInput = document.getElementById("Search");
    const staffTableBody = document.getElementById("staffTableBody");

    let staffData = [];
    let currentStaffRow = null;

async function loadStaff() {
    try {
        const res = await fetch("/employees");
        const result = await res.json();
        if (Array.isArray(result)) {
            staffData = result.map(emp => ({
                id: emp.id,
                staff_id: emp.employee_id,
                name: emp.firstName + " " + emp.lastName,
                email: emp.email || "",
                department: emp.department || "",
                role: emp.role || ""
            }));
            populateStaffTable(staffData);
        } else {
            console.error("Error loading employees:", result.message || result);
        }
    } catch (err) {
        console.error("Failed to load staff:", err);
    }
}


    const addStaffBtn = document.querySelector(".OpenModal");
    addStaffBtn.addEventListener("click", () => {
        document.getElementById("modalTitle").textContent = "Add Staff";
        document.getElementById("Enumber").value = "";
        document.getElementById("email").value = "";
        document.getElementById("fname").value = "";
        document.getElementById("password").value = "";
        document.getElementById("role").value = "Staff";
        document.getElementById("department").value = "Sindangan";
        currentStaffRow = null;
        modal.style.display = "flex";
    });

    function populateStaffTable(data) {
        staffTableBody.innerHTML = "";
        data.forEach((staff) => {
            const row = document.createElement("tr");

            ["staff_id", "name", "email", "department", "role"].forEach(key => {
                const td = document.createElement("td");
                td.textContent = staff[key];
                row.appendChild(td);
            });

            row.setAttribute("row-id", staff.id);

            const actionTd = document.createElement("td");
            actionTd.innerHTML = `
                <span class="OpenModal" style="cursor:pointer; margin-right:10px;"><img src="../static/icons/pencil-fill.png" class="Icon-Table" row-id=${staff.id}></span>
                <span class="DeleteStaff" style="cursor:pointer;"><img src="../static/icons/delete-bin-fill.png" class="Icon-Table"></span>
            `;
            row.appendChild(actionTd);
            staffTableBody.appendChild(row);

            // Update staff
            row.querySelector(".OpenModal").addEventListener("click", () => {
                document.getElementById("modalTitle").textContent = "Update Staff";
                document.getElementById("Enumber").value = staff.staff_id;
                document.getElementById("email").value = staff.email;
                document.getElementById("fname").value = staff.name;
                document.getElementById("password").value = staff.password || "";
                document.getElementById("role").value = staff.role;
                document.getElementById("department").value = staff.department;
                modal.style.display = "flex";
                currentStaffRow = { row, index: staff.id };
            });

            // Delete staff
            row.querySelector(".DeleteStaff").addEventListener("click", () => {
                currentStaffRow = { row, index: staff.id };
                deleteModal.style.display = "flex";
            });
        });
    }

    // Add or Update Staff
 addButton.addEventListener('click', async () => {
    const fullName = document.getElementById("fname").value.trim();
    const nameParts = fullName.split(" "); // split by spaces
    const firstName = nameParts[0] || "";
    const lastName = nameParts.slice(1).join(" ") || "";

    const staff = {
        employee_id: document.getElementById("Enumber").value.trim(),
        email: document.getElementById("email").value.trim(),
        password: document.getElementById("password").value.trim(),
        role: document.getElementById("role").value,
        department: document.getElementById("department").value,
        firstName: firstName,
        lastName: lastName,
        position: document.getElementById("role").value, // or department if you want
        status: "Active",
        contact_number: "" // optional, if your form doesn't have it
    };

    const emptyField = Object.entries(staff).find(([key, value]) => !value && key !== "contact_number");
    if (emptyField) {
        alert(`Please fill in the ${emptyField[0]}`);
        return;
    }

    try {
        let url = "/employees";
        let method = "POST";

        if (currentStaffRow) {
            url = `/employees/${currentStaffRow.index}`;
            method = "PUT";
        }

        const response = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(staff)
        });

        const data = await response.json();
        alert(data.message || JSON.stringify(data));
        modal.style.display = "none";
        loadStaff();
    } catch (err) {
        console.error("Failed to save staff:", err);
    }
});


    // Confirm delete
    confirmDeleteButton.addEventListener("click", async () => {
        try {
            await fetch(`/employees/${currentStaffRow.index}`, { method: "DELETE" });
            deleteModal.style.display = "none";
            loadStaff();
        } catch (err) {
            console.error("Failed to delete staff:", err);
        }
    });

    // Search staff
    searchInput.addEventListener("input", () => {
        const query = searchInput.value.trim().toLowerCase();
        const filtered = staffData.filter(staff =>
            Object.values(staff).some(value =>
                value && value.toString().toLowerCase().includes(query)
            )
        );
        populateStaffTable(filtered);
    });

    // Toggle password visibility
    eyeToggle.addEventListener('click', () => {
        passwordField.type = passwordField.type === "password" ? "text" : "password";
        eyeToggle.src = passwordField.type === "password" ? "../static/icons/eye-off-line.png" : "../static/icons/eye-line.png";
    });

    // Close modals
    closeButton.addEventListener("click", () => modal.style.display = "none");
    closeDeleteButton.addEventListener("click", () => deleteModal.style.display = "none");

    // Load staff initially
    loadStaff();
});

    </script>
</body>

</html>